<!DOCTYPE html>
<html>
<head>
  <title>Let's be Analytical</title>
  <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
  <script type="text/javascript">
  $(document).ready(function() {

    /* commonly used jquery objects */
    var $banner    = $('#banner');
    var $dashboard = $('#dashboard');
    
    var userProfile = null;

    /* function to check for user profile data on the server,
      if it exists return the profile */
    function getProfile( done ) {
      $.get('profileData', function( response, success ) {
        if ( success === "success" ) {
          userProfile = response.data || null;
          done();
        }
        /* if not successful nothing happens */
      })
    }

    function loadPage() {
      getProfile(function() {
        console.log(userProfile)
        if ( userProfile === null ) { renderBannerNotLoggedIn(); }
        else { renderBannerLoggedIn(); }
      })
    }
    loadPage();

    function renderBannerNotLoggedIn() {
      $banner.children('h1')
        .text('You are not logged in.');
      $banner.children('span')
        .text('I really am sorry you have to authenticate. Don\'t worry, what comes next is totally worth it...');
      $banner.children('a')
        .attr('href', '/auth/twitter')
        .text('log in with twitter')
        .click(function(e) {
          e.preventDefault();
          var popup = window.open('/auth/twitter',"");
          window.onfocus = function(e) {
            window.onfocus = null;
            loadPage();
          }
        });
    }

    function renderBannerLoggedIn() {
      console.log('render logged in')
      $banner.children('h1')
        .text('Welcome ' + userProfile.name)
      $banner.children('span')
        .text('Just a sec, fetching your follower\'s profile pictures...');
      $banner.children('a')
        .attr('href', '/logout')
        .text('logout')
        .click(function(e) {
          e.preventDefault();
          // ajax call to kill session
          window.close();
        })
      $.post('/timeToFetchFollowers', function( response, status ) {
        userProfile.followers = response.followers;
        $.get('/analysis', function( response, status ) {
          $banner.children('span')
            .text('Alright! Check that out!');
            userProfile.analytics = response.data;
            renderFollowerDemographics();
        })
      })
    }

    function displayThisFollower( screen_name ) {
      console.log( screen_name );
    }

    function generateSummary() {
      // races
      // ages
      // genders
    }

    function constructFollower( follower, analytics ) {
      var $div = $( '<div class="follower"></div>' )
            .attr( 'id', follower.screen_name );

      var $profile = $( '<img/>' )
            .attr( 'src', follower.profile_image_url );

      var $name = $( '<span/>')
            .text( follower.name );

      var $linkToProfile = $( '<a/>' )
            .attr( 'href', 'https://twitter.com/' + follower.screen_name );

      var $viewMore = $( '<button/>' )
            .text( 'View Stats' )
            .click( function( e ) {
              e.preventDefault();
              displayThisFollower( follower.screen_name );
            });
      var $rightHalf = $( '<div class="follower-panel"></div>' );

      $linkToProfile.append( $profile );
      $div.append( $linkToProfile );
      $rightHalf.append( $name );
      if ( !analytics.face || analytics.face.length === 0 ) {
        $viewMore = $('<span class="unfound">No face found</span>');
      }
      $rightHalf.append( $viewMore );
      $div.append( $rightHalf );
      return $div;
    }


    function renderFollowerDemographics() {
      /* recorrelating the data from face++ and twitter,
        this code is a patch-up for a design flaw on the server
        where the two sets of data are collected independently. */
      userProfile.combinedData = {};
      for ( var i in userProfile.analytics ) {
        userProfile
          .combinedData[ userProfile.analytics[ i ]
            .screen_name ] = { analytics : userProfile.analytics[ i ] }
      }
      for ( var j in userProfile.followers ) {
        userProfile
          .combinedData[ userProfile.followers[ j ]
            .screen_name ].follower = userProfile.followers[ j ];
      }
      /* append summary */


      /* construct boxes for each follower */
      for (var k in userProfile.combinedData ) {
        var followerBox = constructFollower( 
            userProfile.combinedData[ k ].follower,
            userProfile.combinedData[ k ].analytics );
        $dashboard.append(followerBox);
      }

    }


  })
  </script>
  <style type="text/css">
    html, body { height: 99%; width: 100%; margin: 0px; padding: 0px;}


    body {
      font-family: 'arial';
    }

    #banner {
      margin-top: 1%;
      height:     10%;
    }
    #dashboard {
      margin-top: 4%;
      min-height: 64%;
    }
    #footer {
      margin-top: 5%;
      height:     5%;
    }

    .section {
      background-color: #BED0FF;
    }

    .follower {
      display: inline-block;
      width: 400px;
      height: 150px;
      margin: 15px;
      background-color: rgba(255,255,255,0.1);
    }
    .follower img {
      width: 150px;
      height: 150px;
    }
    .follower-panel {
      width: 250px;
      height: 150px;
      display: inline-block;
      float: right;
    }
    .follower-panel button {
      display: block;
    }
    .follower-panel span {
      display: block;
    }
  </style>
</head>
<body>
  <div id="banner" class="section">
    <h1></h1>
    <a href=""></a>
    <span></span>
  </div>
  <div id="dashboard" class="section">
  </div>
  <div id="footer" class="section"></div>
</body>
</html>